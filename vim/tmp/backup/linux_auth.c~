/*
 * getpwnam_auth.c
 *
 * AUTHOR: Erik Hofman <erik.hofman@a1.nl>
 *         Robin Elfrink <robin@a1.nl>
 *
 * Example authentication program for Squid, based on the
 * original proxy_auth code from client_side.c, written by
 * Jon Thackray <jrmt@uk.gdscorp.com>.
 *
 * Uses getpwnam() routines for authentication.
 * This has the following advantages over the NCSA module:
 * 
 * - Allow authentication of all know local users
 * - Allows authentication through nsswitch.conf
 *   + can handle NIS(+) requests
 *   + can handle LDAP request
 *   + can handle PAM request
 *
 */

#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <string.h>
#include <crypt.h>
#include <pwd.h>

#define ERR    "ERR\n"
#define OK     "OK\n"

int 
main()
{
    char buf[256];
    struct passwd *pwd;
    char *user, *passwd, *p;

    setbuf(stdout, NULL);
    while (fgets(buf, 256, stdin) != NULL) {

  if ((p = strchr(buf, '\n')) != NULL)
      *p = '\0';    /* strip \n */

  if ((user = strtok(buf, " ")) == NULL) {
      printf(ERR);
      continue;
  }
  if ((passwd = strtok(NULL, "")) == NULL) {
      printf(ERR);
      continue;
  }
  pwd = getpwnam(user);
  if (pwd == NULL) {
      printf(ERR);
  } else {
      if (strcmp(pwd->pw_passwd, (char *) crypt(passwd, pwd->pw_passwd))) {
    printf(ERR);
      } else {
    printf(OK);
      }
  }
    }
    exit(0);
}
